import soundcard as sc
import numpy as np
import whisper
import threading
import time
import queue
import json
from datetime import datetime
import psutil
import os

class AudioTranscriptionBot:
    def __init__(self):
        print("üîß Inicializando Teams Transcript Bot...")
        print("=" * 50)
        
        # Configuraci√≥n
        self.sample_rate = 48000
        self.chunk_duration = 3  # segundos
        self.is_recording = False
        self.audio_queue = queue.Queue()
        self.transcriptions = []
        
        # Cargar modelo Whisper
        self.load_whisper_model()
        
        # Configurar audio
        self.setup_audio()
        
    def load_whisper_model(self):
        """Cargar modelo Whisper"""
        try:
            print("üì• Cargando modelo Whisper (puede tomar unos minutos la primera vez)...")
            self.whisper_model = whisper.load_model("base")
            print("‚úÖ Modelo Whisper cargado exitosamente")
        except Exception as e:
            print(f"‚ùå Error cargando Whisper: {e}")
            raise
        
    def setup_audio(self):
        """Configurar captura de audio del sistema"""
        try:
            # Obtener dispositivo de salida por defecto (altavoces)
            self.default_speaker = sc.default_speaker()
            print(f"üîä Dispositivo de audio detectado: {self.default_speaker.name}")
            
            # Configurar grabador con loopback para capturar lo que sale por altavoces
            self.recorder = self.default_speaker.recorder(
                samplerate=self.sample_rate,
                channels=1  # Mono es suficiente para voz
            )
            print("‚úÖ Audio configurado correctamente")
            
        except Exception as e:
            print(f"‚ùå Error configurando audio: {e}")
            print("üí° Aseg√∫rate de que el audio est√© funcionando en tu sistema")
            
    def detect_teams_process(self):
        """Detectar si Microsoft Teams est√° ejecut√°ndose"""
        teams_processes = ['teams.exe', 'ms-teams.exe', 'Teams.exe']
        
        for process in psutil.process_iter(['pid', 'name']):
            try:
                process_name = process.info['name']
                if any(teams_proc.lower() in process_name.lower() for teams_proc in teams_processes):
                    print(f"‚úÖ Microsoft Teams detectado: {process_name}")
                    return True
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                continue
        
        return False
    
    def capture_audio_chunk(self):
        """Capturar chunk de audio del sistema"""
        try:
            # Grabar por la duraci√≥n especificada
            audio_data = self.recorder.record(
                numframes=self.sample_rate * self.chunk_duration
            )
            
            # Convertir a numpy array
            audio_array = np.array(audio_data).flatten()
            
            # Verificar que no sea solo silencio
            audio_level = np.max(np.abs(audio_array))
            if audio_level > 0.005:  # Umbral de detecci√≥n de audio
                print(f"üéµ Audio capturado (nivel: {audio_level:.3f})")
                return audio_array
            
        except Exception as e:
            print(f"‚ùå Error capturando audio: {e}")
            
        return None
    
    def transcribe_audio(self, audio_data):
        """Transcribir audio usando Whisper"""
        try:
            # Normalizar audio para Whisper
            audio_normalized = audio_data.astype(np.float32)
            
            # Transcribir con Whisper
            result = self.whisper_model.transcribe(
                audio_normalized,
                language="es",  # Espa√±ol
                fp16=False,     # Usar float32 para compatibilidad
                verbose=False   # No mostrar logs internos
            )
            
            text = result["text"].strip()
            
            # Filtrar transcripciones muy cortas o sin contenido
            if len(text) > 5 and not text.lower() in ['gracias', 'muchas gracias', '']:
                return text
                
        except Exception as e:
            print(f"‚ùå Error en transcripci√≥n: {e}")
            
        return None
    
    def audio_capture_worker(self):
        """Worker thread para captura continua de audio"""
        print("üé§ Iniciando captura de audio...")
        
        while self.is_recording:
            try:
                # Capturar chunk de audio
                audio_chunk = self.capture_audio_chunk()
                
                if audio_chunk is not None:
                    # Enviar a cola de transcripci√≥n
                    self.audio_queue.put(audio_chunk)
                
                # Peque√±a pausa para no saturar CPU
                time.sleep(0.5)
                
            except Exception as e:
                print(f"‚ùå Error en captura: {e}")
                time.sleep(1)
    
    def transcription_worker(self):
        """Worker thread para transcripci√≥n continua"""
        print("üî§ Iniciando motor de transcripci√≥n...")
        
        while self.is_recording or not self.audio_queue.empty():
            try:
                # Obtener audio de la cola
                audio_data = self.audio_queue.get(timeout=2)
                
                # Transcribir
                transcript = self.transcribe_audio(audio_data)
                
                if transcript:
                    timestamp = datetime.now().strftime("%H:%M:%S")
                    
                    # Almacenar transcripci√≥n
                    entry = {
                        "timestamp": timestamp,
                        "text": transcript
                    }
                    self.transcriptions.append(entry)
                    
                    # Mostrar en consola
                    print(f"üìù [{timestamp}] {transcript}")
                
                # Marcar tarea como completada
                self.audio_queue.task_done()
                
            except queue.Empty:
                # Timeout normal, continuar
                continue
            except Exception as e:
                print(f"‚ùå Error en transcripci√≥n: {e}")
    
    def start_recording(self):
        """Iniciar grabaci√≥n y transcripci√≥n"""
        if self.is_recording:
            print("‚ö†Ô∏è La grabaci√≥n ya est√° activa")
            return
            
        print("\nüéØ Verificando sistema...")
        
        # Verificar Teams (opcional)
        if self.detect_teams_process():
            print("‚úÖ Microsoft Teams est√° ejecut√°ndose")
        else:
            print("‚ö†Ô∏è Microsoft Teams no detectado")
            print("üí° El bot funcionar√° de todas formas capturando todo el audio del sistema")
        
        # Iniciar grabaci√≥n
        print("\nüöÄ Iniciando captura y transcripci√≥n...")
        self.is_recording = True
        self.transcriptions = []
        
        # Crear y iniciar threads
        self.audio_thread = threading.Thread(
            target=self.audio_capture_worker, 
            daemon=True,
            name="AudioCapture"
        )
        self.transcription_thread = threading.Thread(
            target=self.transcription_worker, 
            daemon=True,
            name="Transcription"
        )
        
        self.audio_thread.start()
        self.transcription_thread.start()
        
        print("‚úÖ ¬°Sistema activo! Las transcripciones aparecer√°n aqu√≠:")
        print("-" * 50)
        print("üí° Presiona ENTER para detener la grabaci√≥n")
    
    def stop_recording(self):
        """Detener grabaci√≥n y transcripci√≥n"""
        if not self.is_recording:
            print("‚ö†Ô∏è No hay grabaci√≥n activa")
            return
            
        print("\n‚èπÔ∏è Deteniendo grabaci√≥n...")
        self.is_recording = False
        
        # Esperar que terminen los threads
        print("üîÑ Procesando √∫ltimas transcripciones...")
        if hasattr(self, 'audio_thread') and self.audio_thread.is_alive():
            self.audio_thread.join(timeout=5)
        if hasattr(self, 'transcription_thread') and self.transcription_thread.is_alive():
            self.transcription_thread.join(timeout=10)
            
        print("‚úÖ Grabaci√≥n detenida")
    
    def save_transcription(self, filename=None):
        """Guardar transcripci√≥n completa en archivos"""
        if not self.transcriptions:
            print("‚ö†Ô∏è No hay transcripciones para guardar")
            return None
            
        # Generar nombre de archivo si no se proporciona
        if not filename:
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"transcripcion_teams_{timestamp}"
        
        # Guardar como JSON (datos estructurados)
        json_file = f"{filename}.json"
        try:
            with open(json_file, 'w', encoding='utf-8') as f:
                json.dump(self.transcriptions, f, ensure_ascii=False, indent=2)
            print(f"üíæ Transcripci√≥n JSON guardada: {json_file}")
        except Exception as e:
            print(f"‚ùå Error guardando JSON: {e}")
        
        # Guardar como texto plano (f√°cil de leer)
        txt_file = f"{filename}.txt"
        try:
            with open(txt_file, 'w', encoding='utf-8') as f:
                f.write("TRANSCRIPCI√ìN DE REUNI√ìN\n")
                f.write("=" * 30 + "\n")
                f.write(f"Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                f.write(f"Total de entradas: {len(self.transcriptions)}\n\n")
                
                for entry in self.transcriptions:
                    f.write(f"[{entry['timestamp']}] {entry['text']}\n")
                    
            print(f"üìÑ Transcripci√≥n TXT guardada: {txt_file}")
        except Exception as e:
            print(f"‚ùå Error guardando TXT: {e}")
        
        return json_file, txt_file
    
    def get_full_transcript_text(self):
        """Obtener transcripci√≥n completa como texto √∫nico"""
        if not self.transcriptions:
            return ""
        
        return " ".join([entry['text'] for entry in self.transcriptions])
    
    def show_summary(self):
        """Mostrar resumen de la sesi√≥n"""
        print("\n" + "=" * 50)
        print("üìä RESUMEN DE LA SESI√ìN")
        print("=" * 50)
        print(f"üìù Total de transcripciones: {len(self.transcriptions)}")
        
        if self.transcriptions:
            # Calcular duraci√≥n aproximada
            if len(self.transcriptions) > 1:
                start_time = datetime.strptime(self.transcriptions[0]['timestamp'], "%H:%M:%S")
                end_time = datetime.strptime(self.transcriptions[-1]['timestamp'], "%H:%M:%S")
                duration = end_time - start_time
                print(f"‚è±Ô∏è Duraci√≥n aproximada: {duration}")
            
            # Mostrar primeras y √∫ltimas transcripciones
            print(f"\nüìã Primera transcripci√≥n:")
            print(f"   [{self.transcriptions[0]['timestamp']}] {self.transcriptions[0]['text']}")
            
            if len(self.transcriptions) > 1:
                print(f"\nüìã √öltima transcripci√≥n:")
                print(f"   [{self.transcriptions[-1]['timestamp']}] {self.transcriptions[-1]['text']}")
        
        print("=" * 50)

def main():
    """Funci√≥n principal"""
    print("ü§ñ TEAMS AUDIO TRANSCRIPTION BOT")
    print("=" * 50)
    print("üìã Este bot captura el audio de tu sistema y lo transcribe en tiempo real")
    print("üéØ Ideal para reuniones de Teams, Zoom, Meet, etc.")
    print("üí° Aseg√∫rate de tener audio funcionando antes de comenzar")
    print("=" * 50)
    
    # Crear instancia del bot
    try:
        bot = AudioTranscriptionBot()
    except Exception as e:
        print(f"‚ùå Error inicializando el bot: {e}")
        print("üí° Verifica que tengas audio funcionando y permisos adecuados")
        input("Presiona ENTER para salir...")
        return
    
    try:
        # Iniciar grabaci√≥n
        bot.start_recording()
        
        # Esperar a que el usuario presione ENTER
        input()
        
        # Detener grabaci√≥n
        bot.stop_recording()
        
        # Mostrar resumen
        bot.show_summary()
        
        # Guardar transcripci√≥n
        if bot.transcriptions:
            print("\nüíæ Guardando transcripci√≥n...")
            files = bot.save_transcription()
            
            if files:
                print(f"\n‚úÖ Archivos guardados exitosamente")
                print("üéâ ¬°Transcripci√≥n completada!")
        else:
            print("‚ö†Ô∏è No se captur√≥ audio para transcribir")
            print("üí° Verifica que haya audio reproduci√©ndose en tu sistema")
                
    except KeyboardInterrupt:
        print("\n\nüëã Interrumpido por el usuario")
        bot.stop_recording()
    except Exception as e:
        print(f"\n‚ùå Error durante la ejecuci√≥n: {e}")
        bot.stop_recording()
    
    print("\nüîö Aplicaci√≥n finalizada")
    input("Presiona ENTER para cerrar...")

if __name__ == "__main__":
    main()
